{"ast":null,"code":"import _createForOfIteratorHelper from\"/Users/albert/projects/med-bakery-react/client/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper\";import _objectSpread from\"/Users/albert/projects/med-bakery-react/client/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _regeneratorRuntime from\"/Users/albert/projects/med-bakery-react/client/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/albert/projects/med-bakery-react/client/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/Users/albert/projects/med-bakery-react/client/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import axios from\"axios\";import{useEffect,useState}from\"react\";import WaveSurfer from\"wavesurfer.js\";import{produceHeat}from\"../../functions\";import{startAudioRecordingId}from\"./types\";export var useLoopTime=function useLoopTime(upperLimit){var _useState=useState(upperLimit),_useState2=_slicedToArray(_useState,2),time=_useState2[0],setTime=_useState2[1];useEffect(function(){var interval=setInterval(function(){setTime(function(time){if(time===0){clearInterval(interval);return 0;}else return time-1;});},1000);return function(){return clearInterval(interval);};},[]);return time;};export var playStartTone=function playStartTone(){var _document$getElementB;return(_document$getElementB=document.getElementById(startAudioRecordingId))===null||_document$getElementB===void 0?void 0:_document$getElementB.play();};var handleAudioSession=function handleAudioSession(stream,updateFunc,startFunc){// cannot make media recorder if stream invalid\nif(!stream)return;var recorder=new MediaRecorder(stream);recorder.ondataavailable=function(e){var blob=new Blob([e.data],{type:\"audio/ogg; codecs=opus\"});updateFunc(window.URL.createObjectURL(blob));};recorder.onstart=startFunc;recorder.onstop=function(){stream.getTracks().forEach(function(track){return track.stop();});playStartTone();};recorder.start();return recorder;};export var useRecorder=function useRecorder(updateFunc,startFunc){var _useState3=useState(),_useState4=_slicedToArray(_useState3,2),recorder=_useState4[0],updateRecorder=_useState4[1];// attempt to retrieve a user input stream\nvar startRecorder=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var sesh,_recorder;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;_context.next=3;return navigator.mediaDevices.getUserMedia({audio:true});case 3:sesh=_context.sent;_recorder=handleAudioSession(sesh,updateFunc,startFunc);updateRecorder(_recorder);produceHeat(11);_context.next=12;break;case 9:_context.prev=9;_context.t0=_context[\"catch\"](0);console.error(\"startRecorder (hooks.tsx): Failed to commence audio session\");case 12:case\"end\":return _context.stop();}}},_callee,null,[[0,9]]);}));return function startRecorder(){return _ref.apply(this,arguments);};}();return[startRecorder,function(){return recorder===null||recorder===void 0?void 0:recorder.stop();}];};export var generateWaveSurfer=function generateWaveSurfer(containerId,audioUrl){var ws=WaveSurfer.create(waveSurferParams(containerId));if(audioUrl)ws.load(audioUrl);return ws;};export var waveSurferParams=function waveSurferParams(containerId){return{container:\"#\"+containerId,waveColor:\"white\",progressColor:\"#FAD000\",height:20,cursorWidth:0,hideScrollbar:true};};export var toggleMarkPoint=function toggleMarkPoint(station,questionIdx,pointId){return _objectSpread(_objectSpread({},station),{},{questions:station.questions.map(function(q,i){return i===questionIdx?_objectSpread(_objectSpread({},q),{},{markScheme:q.markScheme.map(function(ms){return _objectSpread(_objectSpread({},ms),{},{points:ms.points.map(function(pt){return _objectSpread(_objectSpread({},pt),{},{selected:pt.pointId===pointId?!pt.selected:pt.selected});})});})}):q;})});};export var countPoints=function countPoints(markScheme){return markScheme.reduce(function(acc,a){return[acc[0]+a.points.reduce(function(total,pt){return total+(pt.selected?1:0);},0),acc[1]+a.points.length];},[0,0]);};export var binaryToCode=function binaryToCode(points){var arr=points.reverse();return arr.reduce(function(acc,n,i){return acc+=n*Math.pow(2,i);},0);};export var getBinaryDigits=function getBinaryDigits(n){var curr=n;var arr=[];while(curr>0){arr.push(curr%2===0?0:1);curr=Math.floor(curr/2);}return arr.reverse();};export var markPercentage=function markPercentage(markCode){var marks=getBinaryDigits(markCode).slice(1);return marks.length>0?Math.round(100*marks.reduce(function(a,b){return a+b;},0)/marks.length):0;};export var populateMarkScheme=function populateMarkScheme(station,marks){var idx=0;station.questions.forEach(function(q){return q.markScheme.forEach(function(ms){return ms.points.forEach(function(p){p.selected=marks[idx]===1;idx+=1;});});});return station;};export var rawToUrl=function rawToUrl(raw,type){var byteArray=new Uint8Array(raw.length);for(var i=0;i<raw.length;i++){byteArray[i]=raw.charCodeAt(i);}return window.URL.createObjectURL(new Blob([byteArray],{type:type}));};export var populateResponseAudios=function populateResponseAudios(station,responseAudios){station.questions.forEach(function(q,i){q.responseAudio=rawToUrl(responseAudios[i],\"audio/mp3\");});return station;};export var downloadAssets=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(station,SERVER_URL){var _iterator,_step,question;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_iterator=_createForOfIteratorHelper(station.questions);_context2.prev=1;_iterator.s();case 3:if((_step=_iterator.n()).done){_context2.next=16;break;}question=_step.value;_context2.next=7;return convertToLocal(question.exemplarAudio,SERVER_URL);case 7:question.exemplarAudio=_context2.sent;_context2.next=10;return convertToLocal(question.questionAudio,SERVER_URL);case 10:question.questionAudio=_context2.sent;_context2.next=13;return convertToLocal(question.img,SERVER_URL);case 13:question.img=_context2.sent;case 14:_context2.next=3;break;case 16:_context2.next=21;break;case 18:_context2.prev=18;_context2.t0=_context2[\"catch\"](1);_iterator.e(_context2.t0);case 21:_context2.prev=21;_iterator.f();return _context2.finish(21);case 24:return _context2.abrupt(\"return\",new Promise(function(r,_){return r(station);}));case 25:case\"end\":return _context2.stop();}}},_callee2,null,[[1,18,21,24]]);}));return function downloadAssets(_x,_x2){return _ref2.apply(this,arguments);};}();var convertToLocal=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(remoteUrl,SERVER_URL){var fres;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.next=2;return fetch(SERVER_URL+\"/media/osce/\"+remoteUrl);case 2:fres=_context4.sent;return _context4.abrupt(\"return\",new Promise(/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(r,_){return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.t0=r;_context3.t1=window.URL;_context3.next=4;return fres.blob();case 4:_context3.t2=_context3.sent;_context3.t3=_context3.t1.createObjectURL.call(_context3.t1,_context3.t2);return _context3.abrupt(\"return\",(0,_context3.t0)(_context3.t3));case 7:case\"end\":return _context3.stop();}}},_callee3);}));return function(_x5,_x6){return _ref4.apply(this,arguments);};}()));case 4:case\"end\":return _context4.stop();}}},_callee4);}));return function convertToLocal(_x3,_x4){return _ref3.apply(this,arguments);};}();export var extractReponseAudio=/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee6(questions){var arrays;return _regeneratorRuntime.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:arrays=questions.map(/*#__PURE__*/function(){var _ref6=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(question){var res,buffer;return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:if(!(question.responseAudio===\"\")){_context5.next=2;break;}return _context5.abrupt(\"return\",\"\");case 2:_context5.next=4;return fetch(question.responseAudio);case 4:res=_context5.sent;_context5.next=7;return res.arrayBuffer();case 7:buffer=_context5.sent;return _context5.abrupt(\"return\",Buffer.from(buffer).toString(\"binary\"));case 9:case\"end\":return _context5.stop();}}},_callee5);}));return function(_x8){return _ref6.apply(this,arguments);};}());return _context6.abrupt(\"return\",Promise.all(arrays));case 2:case\"end\":return _context6.stop();}}},_callee6);}));return function extractReponseAudio(_x7){return _ref5.apply(this,arguments);};}();export var convertToString=function convertToString(time){var minutes=Math.floor(time/60);var minuteString=minutes<10?\"0\"+minutes:\"\"+minutes;var seconds=time%60;var secondsString=seconds<10?\"0\"+seconds:\"\"+seconds;return minuteString+\":\"+secondsString;};export var useUserDetails=function useUserDetails(SERVER_URL,token){var _useState5=useState(false),_useState6=_slicedToArray(_useState5,2),userLoading=_useState6[0],updateUserLoading=_useState6[1];var _useState7=useState({answeredStations:[],purchasedOsce:false}),_useState8=_slicedToArray(_useState7,2),userDetailsOsce=_useState8[0],updateUserDetailsOsce=_useState8[1];var loadUserDetails=/*#__PURE__*/function(){var _ref7=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee7(){var res,_res$data,answeredStations,purchasedOsce;return _regeneratorRuntime.wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:updateUserLoading(true);_context7.prev=1;_context7.next=4;return axios.post(SERVER_URL+\"/user/osce_details\",{token:token});case 4:res=_context7.sent;if(res.data.success){_context7.next=7;break;}throw\"loadUserDetails (OSCEPage.tsx): user details retrieval failed\";case 7:_res$data=res.data,answeredStations=_res$data.answeredStations,purchasedOsce=_res$data.purchasedOsce;updateUserDetailsOsce({answeredStations:answeredStations,purchasedOsce:purchasedOsce});_context7.next=14;break;case 11:_context7.prev=11;_context7.t0=_context7[\"catch\"](1);console.error(_context7.t0);case 14:updateUserLoading(false);case 15:case\"end\":return _context7.stop();}}},_callee7,null,[[1,11]]);}));return function loadUserDetails(){return _ref7.apply(this,arguments);};}();useEffect(function(){if(token){loadUserDetails();}else{updateUserDetailsOsce({answeredStations:[],purchasedOsce:false});}},[token]);return[userDetailsOsce,userLoading];};export var useStations=function useStations(SERVER_URL,token){var _useState9=useState(false),_useState10=_slicedToArray(_useState9,2),stationeSummariesLoading=_useState10[0],updateSummariesLoading=_useState10[1];var _useState11=useState([]),_useState12=_slicedToArray(_useState11,2),stationSummarires=_useState12[0],updateStationSummaries=_useState12[1];var loadSummaries=/*#__PURE__*/function(){var _ref8=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee8(){var res;return _regeneratorRuntime.wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:updateSummariesLoading(true);_context8.prev=1;_context8.next=4;return axios.post(SERVER_URL+\"/osce/get_stations\",{token:token});case 4:res=_context8.sent;if(res.data.success){_context8.next=7;break;}throw\"loadSummaries (OSCEPage.tsx): station summary retrieval failed\";case 7:updateStationSummaries(res.data.summaries);_context8.next=13;break;case 10:_context8.prev=10;_context8.t0=_context8[\"catch\"](1);console.error(_context8.t0);case 13:updateSummariesLoading(false);case 14:case\"end\":return _context8.stop();}}},_callee8,null,[[1,10]]);}));return function loadSummaries(){return _ref8.apply(this,arguments);};}();// cant have asynchronous effect callback\nuseEffect(function(){loadSummaries();},[]);return[stationSummarires,stationeSummariesLoading];};","map":{"version":3,"sources":["/Users/albert/projects/med-bakery-react/client/src/components/OSCEPage/hooks.tsx"],"names":["axios","useEffect","useState","WaveSurfer","produceHeat","startAudioRecordingId","useLoopTime","upperLimit","time","setTime","interval","setInterval","clearInterval","playStartTone","document","getElementById","play","handleAudioSession","stream","updateFunc","startFunc","recorder","MediaRecorder","ondataavailable","e","blob","Blob","data","type","window","URL","createObjectURL","onstart","onstop","getTracks","forEach","track","stop","start","useRecorder","updateRecorder","startRecorder","navigator","mediaDevices","getUserMedia","audio","sesh","console","error","generateWaveSurfer","containerId","audioUrl","ws","create","waveSurferParams","load","container","waveColor","progressColor","height","cursorWidth","hideScrollbar","toggleMarkPoint","station","questionIdx","pointId","questions","map","q","i","markScheme","ms","points","pt","selected","countPoints","reduce","acc","a","total","length","binaryToCode","arr","reverse","n","Math","pow","getBinaryDigits","curr","push","floor","markPercentage","markCode","marks","slice","round","b","populateMarkScheme","idx","p","rawToUrl","raw","byteArray","Uint8Array","charCodeAt","populateResponseAudios","responseAudios","responseAudio","downloadAssets","SERVER_URL","question","convertToLocal","exemplarAudio","questionAudio","img","Promise","r","_","remoteUrl","fetch","fres","extractReponseAudio","arrays","res","arrayBuffer","buffer","Buffer","from","toString","all","convertToString","minutes","minuteString","seconds","secondsString","useUserDetails","token","userLoading","updateUserLoading","answeredStations","purchasedOsce","userDetailsOsce","updateUserDetailsOsce","loadUserDetails","post","success","useStations","stationeSummariesLoading","updateSummariesLoading","stationSummarires","updateStationSummaries","loadSummaries","summaries"],"mappings":"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","sourcesContent":["import axios from \"axios\";\nimport { useEffect, useState } from \"react\";\nimport WaveSurfer from \"wavesurfer.js\";\nimport { produceHeat } from \"../../functions\";\nimport {\n    MarkSchemeSection,\n    mimeTypes,\n    Question,\n    startAudioRecordingId,\n    Station,\n    StationSummary,\n    UserDetailsOsce,\n} from \"./types\";\n\nexport const useLoopTime = (upperLimit: number): number => {\n    const [time, setTime] = useState(upperLimit);\n\n    useEffect(() => {\n        const interval = setInterval(() => {\n            setTime(time => {\n                if (time === 0) {\n                    clearInterval(interval);\n                    return 0;\n                } else return time - 1;\n            });\n        }, 1000);\n\n        return () => clearInterval(interval);\n    }, []);\n\n    return time;\n};\n\nexport const playStartTone = () =>\n    (document.getElementById(startAudioRecordingId) as HTMLAudioElement)?.play();\n\nconst handleAudioSession = (\n    stream: MediaStream,\n    updateFunc: (audio: string) => void,\n    startFunc: () => void\n) => {\n    // cannot make media recorder if stream invalid\n    if (!stream) return;\n\n    const recorder = new MediaRecorder(stream);\n\n    recorder.ondataavailable = function (this, e) {\n        const blob = new Blob([e.data], { type: \"audio/ogg; codecs=opus\" });\n        updateFunc(window.URL.createObjectURL(blob));\n    };\n\n    recorder.onstart = startFunc;\n\n    recorder.onstop = () => {\n        stream.getTracks().forEach(track => track.stop());\n        playStartTone();\n    };\n\n    recorder.start();\n\n    return recorder;\n};\n\nexport const useRecorder = (\n    updateFunc: (audio: string) => void,\n    startFunc: () => void\n): [() => void, () => void] => {\n    const [recorder, updateRecorder] = useState<MediaRecorder>();\n\n    // attempt to retrieve a user input stream\n    const startRecorder = async () => {\n        try {\n            const sesh = await navigator.mediaDevices.getUserMedia({ audio: true });\n            const recorder = handleAudioSession(sesh, updateFunc, startFunc);\n            updateRecorder(recorder);\n            produceHeat(11);\n        } catch (e) {\n            console.error(\"startRecorder (hooks.tsx): Failed to commence audio session\");\n        }\n    };\n\n    return [startRecorder, () => recorder?.stop()];\n};\n\nexport const generateWaveSurfer = (containerId: string, audioUrl: string) => {\n    const ws = WaveSurfer.create(waveSurferParams(containerId));\n    if (audioUrl) ws.load(audioUrl);\n    return ws;\n};\n\nexport const waveSurferParams = (containerId: string) => ({\n    container: \"#\" + containerId,\n    waveColor: \"white\",\n    progressColor: \"#FAD000\",\n    height: 20,\n    cursorWidth: 0,\n    hideScrollbar: true,\n});\n\nexport const toggleMarkPoint = (\n    station: Station,\n    questionIdx: number,\n    pointId: number\n): Station => ({\n    ...station,\n    questions: station.questions.map((q, i) =>\n        i === questionIdx\n            ? {\n                  ...q,\n                  markScheme: q.markScheme.map(ms => ({\n                      ...ms,\n                      points: ms.points.map(pt => ({\n                          ...pt,\n                          selected: pt.pointId === pointId ? !pt.selected : pt.selected,\n                      })),\n                  })),\n              }\n            : q\n    ),\n});\n\nexport const countPoints = (markScheme: MarkSchemeSection[]): [number, number] => {\n    return markScheme.reduce(\n        (acc, a) => {\n            return [\n                acc[0] + a.points.reduce((total, pt) => total + (pt.selected ? 1 : 0), 0),\n                acc[1] + a.points.length,\n            ];\n        },\n        [0, 0]\n    );\n};\n\nexport const binaryToCode = (points: (0 | 1)[]): number => {\n    const arr = points.reverse();\n    return arr.reduce((acc, n, i) => (acc += n * Math.pow(2, i)), 0 as number);\n};\n\nexport const getBinaryDigits = (n: number): (0 | 1)[] => {\n    let curr = n;\n    let arr: (0 | 1)[] = [];\n    while (curr > 0) {\n        arr.push(curr % 2 === 0 ? 0 : 1);\n        curr = Math.floor(curr / 2);\n    }\n    return arr.reverse();\n};\n\nexport const markPercentage = (markCode: number): number => {\n    const marks = getBinaryDigits(markCode).slice(1);\n    return marks.length > 0\n        ? Math.round((100 * marks.reduce((a, b) => a + b, 0 as number)) / marks.length)\n        : 0;\n};\n\nexport const populateMarkScheme = (station: Station, marks: (0 | 1)[]): Station => {\n    let idx = 0;\n    station.questions.forEach(q =>\n        q.markScheme.forEach(ms =>\n            ms.points.forEach(p => {\n                p.selected = marks[idx] === 1;\n                idx += 1;\n            })\n        )\n    );\n    return station;\n};\n\nexport const rawToUrl = (raw: string, type: string): string => {\n    const byteArray = new Uint8Array(raw.length);\n    for (let i = 0; i < raw.length; i++) {\n        byteArray[i] = raw.charCodeAt(i);\n    }\n    return window.URL.createObjectURL(new Blob([byteArray], { type }));\n};\n\nexport const populateResponseAudios = (station: Station, responseAudios: string[]): Station => {\n    station.questions.forEach((q, i) => {\n        q.responseAudio = rawToUrl(responseAudios[i], \"audio/mp3\");\n    });\n    return station;\n};\n\nexport const downloadAssets = async (station: Station, SERVER_URL: string): Promise<Station> => {\n    for (const question of station.questions) {\n        // get local copies of exemplar, question and img\n        question.exemplarAudio = await convertToLocal(question.exemplarAudio, SERVER_URL);\n        question.questionAudio = await convertToLocal(question.questionAudio, SERVER_URL);\n        question.img = await convertToLocal(question.img, SERVER_URL);\n    }\n    return new Promise((r, _) => r(station));\n};\n\nconst convertToLocal = async (remoteUrl: string, SERVER_URL: string): Promise<string> => {\n    const fres = await fetch(SERVER_URL + \"/media/osce/\" + remoteUrl);\n    return new Promise(async (r, _) => r(window.URL.createObjectURL(await fres.blob())));\n};\n\nexport const extractReponseAudio = async (questions: Question[]): Promise<string[]> => {\n    const arrays = questions.map(async question => {\n        if (question.responseAudio === \"\") return \"\";\n        const res = await fetch(question.responseAudio);\n        const buffer = await res.arrayBuffer(); // <== no audio upload on iphone bug\n        return Buffer.from(buffer).toString(\"binary\");\n    });\n    return Promise.all(arrays);\n};\n\nexport const convertToString = (time: number) => {\n    const minutes = Math.floor(time / 60);\n    const minuteString = minutes < 10 ? \"0\" + minutes : \"\" + minutes;\n    const seconds = time % 60;\n    const secondsString = seconds < 10 ? \"0\" + seconds : \"\" + seconds;\n    return minuteString + \":\" + secondsString;\n};\n\nexport const useUserDetails = (SERVER_URL: string, token: string): [UserDetailsOsce, boolean] => {\n    const [userLoading, updateUserLoading] = useState(false);\n    const [userDetailsOsce, updateUserDetailsOsce] = useState<UserDetailsOsce>({\n        answeredStations: [],\n        purchasedOsce: false,\n    });\n\n    const loadUserDetails = async () => {\n        updateUserLoading(true);\n\n        try {\n            const res = await axios.post(SERVER_URL + \"/user/osce_details\", { token });\n\n            if (!res.data.success) {\n                throw \"loadUserDetails (OSCEPage.tsx): user details retrieval failed\";\n            }\n\n            const { answeredStations, purchasedOsce } = res.data;\n            updateUserDetailsOsce({ answeredStations, purchasedOsce });\n        } catch (error) {\n            console.error(error);\n        }\n\n        updateUserLoading(false);\n    };\n\n    useEffect(() => {\n        if (token) {\n            loadUserDetails();\n        } else {\n            updateUserDetailsOsce({\n                answeredStations: [],\n                purchasedOsce: false,\n            });\n        }\n    }, [token]);\n\n    return [userDetailsOsce, userLoading];\n};\n\nexport const useStations = (\n    SERVER_URL: string,\n    token: string\n): [stations: StationSummary[], loading: boolean] => {\n    const [stationeSummariesLoading, updateSummariesLoading] = useState(false);\n    const [stationSummarires, updateStationSummaries] = useState<StationSummary[]>([]);\n\n    const loadSummaries = async () => {\n        updateSummariesLoading(true);\n\n        try {\n            const res = await axios.post(SERVER_URL + \"/osce/get_stations\", { token });\n\n            if (!res.data.success) {\n                throw \"loadSummaries (OSCEPage.tsx): station summary retrieval failed\";\n            }\n\n            updateStationSummaries(res.data.summaries);\n        } catch (error) {\n            console.error(error);\n        }\n        updateSummariesLoading(false);\n    };\n\n    // cant have asynchronous effect callback\n    useEffect(() => {\n        loadSummaries();\n    }, []);\n\n    return [stationSummarires, stationeSummariesLoading];\n};\n"]},"metadata":{},"sourceType":"module"}