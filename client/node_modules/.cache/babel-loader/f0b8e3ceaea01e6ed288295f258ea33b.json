{"ast":null,"code":"import _createForOfIteratorHelper from \"/Users/albert/projects/med-bakery-react/client/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper\";\nimport _objectSpread from \"/Users/albert/projects/med-bakery-react/client/node_modules/@babel/runtime/helpers/esm/objectSpread2\";\nimport _regeneratorRuntime from \"/Users/albert/projects/med-bakery-react/client/node_modules/@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"/Users/albert/projects/med-bakery-react/client/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _slicedToArray from \"/Users/albert/projects/med-bakery-react/client/node_modules/@babel/runtime/helpers/esm/slicedToArray\";\n\nvar _s = $RefreshSig$(),\n    _s2 = $RefreshSig$();\n\nimport { useEffect, useState } from \"react\";\nimport WaveSurfer from \"wavesurfer.js\";\nimport { produceHeat } from \"../../functions\";\nimport { startAudioRecordingId } from \"./types\";\nexport var useLoopTime = function useLoopTime(upperLimit) {\n  _s();\n\n  var _useState = useState(upperLimit),\n      _useState2 = _slicedToArray(_useState, 2),\n      time = _useState2[0],\n      setTime = _useState2[1];\n\n  useEffect(function () {\n    var interval = setInterval(function () {\n      setTime(function (time) {\n        if (time === 0) {\n          clearInterval(interval);\n          return 0;\n        } else return time - 1;\n      });\n    }, 1000);\n    return function () {\n      return clearInterval(interval);\n    };\n  }, []);\n  return time;\n};\n\n_s(useLoopTime, \"HAa3Zkp51pBKEVcKaVE0XDzjv8k=\");\n\nexport var playStartTone = function playStartTone() {\n  var _document$getElementB;\n\n  return (_document$getElementB = document.getElementById(startAudioRecordingId)) === null || _document$getElementB === void 0 ? void 0 : _document$getElementB.play();\n};\n\nvar handleAudioSession = function handleAudioSession(stream, updateFunc, startFunc) {\n  // cannot make media recorder if stream invalid\n  if (!stream) return;\n  var recorder = new MediaRecorder(stream);\n\n  recorder.ondataavailable = function (e) {\n    var blob = new Blob([e.data], {\n      type: \"audio/ogg; codecs=opus\"\n    });\n    updateFunc(window.URL.createObjectURL(blob));\n  };\n\n  recorder.onstart = startFunc;\n\n  recorder.onstop = function () {\n    stream.getTracks().forEach(function (track) {\n      return track.stop();\n    });\n    playStartTone();\n  };\n\n  recorder.start();\n  return recorder;\n};\n\nexport var useRecorder = function useRecorder(updateFunc, startFunc) {\n  _s2();\n\n  var _useState3 = useState(),\n      _useState4 = _slicedToArray(_useState3, 2),\n      recorder = _useState4[0],\n      updateRecorder = _useState4[1]; // attempt to retrieve a user input stream\n\n\n  var startRecorder = /*#__PURE__*/function () {\n    var _ref = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n      var sesh, _recorder;\n\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              _context.prev = 0;\n              _context.next = 3;\n              return navigator.mediaDevices.getUserMedia({\n                audio: true\n              });\n\n            case 3:\n              sesh = _context.sent;\n              _recorder = handleAudioSession(sesh, updateFunc, startFunc);\n              updateRecorder(_recorder);\n              produceHeat(11);\n              _context.next = 12;\n              break;\n\n            case 9:\n              _context.prev = 9;\n              _context.t0 = _context[\"catch\"](0);\n              console.error(\"startRecorder (hooks.tsx): Failed to commence audio session\");\n\n            case 12:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee, null, [[0, 9]]);\n    }));\n\n    return function startRecorder() {\n      return _ref.apply(this, arguments);\n    };\n  }();\n\n  return [startRecorder, function () {\n    return recorder === null || recorder === void 0 ? void 0 : recorder.stop();\n  }];\n};\n\n_s2(useRecorder, \"AWW46P3126+v/4zylA7z458PW8w=\");\n\nexport var generateWaveSurfer = function generateWaveSurfer(containerId, audioUrl, finishCallback) {\n  var ws = WaveSurfer.create(waveSurferParams(containerId));\n  if (audioUrl) ws.load(audioUrl);\n  ws.on(\"finish\", finishCallback);\n  return ws;\n};\nexport var waveSurferParams = function waveSurferParams(containerId) {\n  return {\n    container: \"#\" + containerId,\n    waveColor: \"white\",\n    progressColor: \"#FAD000\",\n    height: 30,\n    cursorWidth: 0,\n    hideScrollbar: true\n  };\n};\nexport var toggleMarkPoint = function toggleMarkPoint(station, questionIdx, pointId) {\n  return _objectSpread(_objectSpread({}, station), {}, {\n    questions: station.questions.map(function (q, i) {\n      return i === questionIdx ? _objectSpread(_objectSpread({}, q), {}, {\n        markScheme: q.markScheme.map(function (ms) {\n          return _objectSpread(_objectSpread({}, ms), {}, {\n            points: ms.points.map(function (pt) {\n              return _objectSpread(_objectSpread({}, pt), {}, {\n                selected: pt.pointId === pointId ? !pt.selected : pt.selected\n              });\n            })\n          });\n        })\n      }) : q;\n    })\n  });\n};\nexport var countPoints = function countPoints(markScheme) {\n  return markScheme.reduce(function (acc, a) {\n    return [acc[0] + a.points.reduce(function (total, pt) {\n      return total + (pt.selected ? 1 : 0);\n    }, 0), acc[1] + a.points.length];\n  }, [0, 0]);\n};\nexport var binaryToCode = function binaryToCode(points) {\n  var arr = points.reverse();\n  return arr.reduce(function (acc, n, i) {\n    return acc += n * Math.pow(2, i);\n  }, 0);\n};\nexport var getBinaryDigits = function getBinaryDigits(n) {\n  var curr = n;\n  var arr = [];\n\n  while (curr > 0) {\n    arr.push(curr % 2 === 0 ? 0 : 1);\n    curr = Math.floor(curr / 2);\n  }\n\n  return arr.reverse();\n};\nexport var populateMarkScheme = function populateMarkScheme(station, marks) {\n  var idx = 0;\n  station.questions.forEach(function (q) {\n    return q.markScheme.forEach(function (ms) {\n      return ms.points.forEach(function (p) {\n        p.selected = marks[idx] === 1;\n        idx += 1;\n      });\n    });\n  });\n  return station;\n};\nexport var rawToUrl = function rawToUrl(raw, type) {\n  var byteArray = new Uint8Array(raw.length);\n\n  for (var i = 0; i < raw.length; i++) {\n    byteArray[i] = raw.charCodeAt(i);\n  }\n\n  return window.URL.createObjectURL(new Blob([byteArray], {\n    type: type\n  }));\n};\nexport var populateResponseAudios = function populateResponseAudios(station, responseAudios) {\n  station.questions.forEach(function (q, i) {\n    q.responseAudio = rawToUrl(responseAudios[i], \"audio/mp3\");\n  });\n  return station;\n};\nexport var downloadAssets = /*#__PURE__*/function () {\n  var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(station, SERVER_URL) {\n    var _iterator, _step, question;\n\n    return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n      while (1) {\n        switch (_context2.prev = _context2.next) {\n          case 0:\n            _iterator = _createForOfIteratorHelper(station.questions);\n            _context2.prev = 1;\n\n            _iterator.s();\n\n          case 3:\n            if ((_step = _iterator.n()).done) {\n              _context2.next = 16;\n              break;\n            }\n\n            question = _step.value;\n            _context2.next = 7;\n            return convertToLocal(question.exemplarAudio, SERVER_URL);\n\n          case 7:\n            question.exemplarAudio = _context2.sent;\n            _context2.next = 10;\n            return convertToLocal(question.questionAudio, SERVER_URL);\n\n          case 10:\n            question.questionAudio = _context2.sent;\n            _context2.next = 13;\n            return convertToLocal(question.img, SERVER_URL);\n\n          case 13:\n            question.img = _context2.sent;\n\n          case 14:\n            _context2.next = 3;\n            break;\n\n          case 16:\n            _context2.next = 21;\n            break;\n\n          case 18:\n            _context2.prev = 18;\n            _context2.t0 = _context2[\"catch\"](1);\n\n            _iterator.e(_context2.t0);\n\n          case 21:\n            _context2.prev = 21;\n\n            _iterator.f();\n\n            return _context2.finish(21);\n\n          case 24:\n            return _context2.abrupt(\"return\", new Promise(function (r, _) {\n              return r(station);\n            }));\n\n          case 25:\n          case \"end\":\n            return _context2.stop();\n        }\n      }\n    }, _callee2, null, [[1, 18, 21, 24]]);\n  }));\n\n  return function downloadAssets(_x, _x2) {\n    return _ref2.apply(this, arguments);\n  };\n}();\n\nvar convertToLocal = /*#__PURE__*/function () {\n  var _ref3 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4(remoteUrl, SERVER_URL) {\n    var fres;\n    return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n      while (1) {\n        switch (_context4.prev = _context4.next) {\n          case 0:\n            _context4.next = 2;\n            return fetch(SERVER_URL + \"/media/osce/\" + remoteUrl);\n\n          case 2:\n            fres = _context4.sent;\n            return _context4.abrupt(\"return\", new Promise( /*#__PURE__*/function () {\n              var _ref4 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(r, _) {\n                return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n                  while (1) {\n                    switch (_context3.prev = _context3.next) {\n                      case 0:\n                        _context3.t0 = r;\n                        _context3.t1 = window.URL;\n                        _context3.next = 4;\n                        return fres.blob();\n\n                      case 4:\n                        _context3.t2 = _context3.sent;\n                        _context3.t3 = _context3.t1.createObjectURL.call(_context3.t1, _context3.t2);\n                        return _context3.abrupt(\"return\", (0, _context3.t0)(_context3.t3));\n\n                      case 7:\n                      case \"end\":\n                        return _context3.stop();\n                    }\n                  }\n                }, _callee3);\n              }));\n\n              return function (_x5, _x6) {\n                return _ref4.apply(this, arguments);\n              };\n            }()));\n\n          case 4:\n          case \"end\":\n            return _context4.stop();\n        }\n      }\n    }, _callee4);\n  }));\n\n  return function convertToLocal(_x3, _x4) {\n    return _ref3.apply(this, arguments);\n  };\n}();\n\nexport var extractReponseAudio = /*#__PURE__*/function () {\n  var _ref5 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee6(questions) {\n    var arrays;\n    return _regeneratorRuntime.wrap(function _callee6$(_context6) {\n      while (1) {\n        switch (_context6.prev = _context6.next) {\n          case 0:\n            arrays = questions.map( /*#__PURE__*/function () {\n              var _ref6 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee5(question) {\n                var res, buffer;\n                return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n                  while (1) {\n                    switch (_context5.prev = _context5.next) {\n                      case 0:\n                        if (!(question.responseAudio === \"\")) {\n                          _context5.next = 2;\n                          break;\n                        }\n\n                        return _context5.abrupt(\"return\", \"\");\n\n                      case 2:\n                        _context5.next = 4;\n                        return fetch(question.responseAudio);\n\n                      case 4:\n                        res = _context5.sent;\n                        _context5.next = 7;\n                        return res.arrayBuffer();\n\n                      case 7:\n                        buffer = _context5.sent;\n                        return _context5.abrupt(\"return\", Buffer.from(buffer).toString(\"binary\"));\n\n                      case 9:\n                      case \"end\":\n                        return _context5.stop();\n                    }\n                  }\n                }, _callee5);\n              }));\n\n              return function (_x8) {\n                return _ref6.apply(this, arguments);\n              };\n            }());\n            return _context6.abrupt(\"return\", Promise.all(arrays));\n\n          case 2:\n          case \"end\":\n            return _context6.stop();\n        }\n      }\n    }, _callee6);\n  }));\n\n  return function extractReponseAudio(_x7) {\n    return _ref5.apply(this, arguments);\n  };\n}();\nexport var convertToString = function convertToString(time) {\n  var minutes = Math.floor(time / 60);\n  var minuteString = minutes < 10 ? \"0\" + minutes : \"\" + minutes;\n  var seconds = time % 60;\n  var secondsString = seconds < 10 ? \"0\" + seconds : \"\" + seconds;\n  return minuteString + \":\" + secondsString;\n};","map":{"version":3,"sources":["/Users/albert/projects/med-bakery-react/client/src/components/OSCEPage/hooks.tsx"],"names":["useEffect","useState","WaveSurfer","produceHeat","startAudioRecordingId","useLoopTime","upperLimit","time","setTime","interval","setInterval","clearInterval","playStartTone","document","getElementById","play","handleAudioSession","stream","updateFunc","startFunc","recorder","MediaRecorder","ondataavailable","e","blob","Blob","data","type","window","URL","createObjectURL","onstart","onstop","getTracks","forEach","track","stop","start","useRecorder","updateRecorder","startRecorder","navigator","mediaDevices","getUserMedia","audio","sesh","console","error","generateWaveSurfer","containerId","audioUrl","finishCallback","ws","create","waveSurferParams","load","on","container","waveColor","progressColor","height","cursorWidth","hideScrollbar","toggleMarkPoint","station","questionIdx","pointId","questions","map","q","i","markScheme","ms","points","pt","selected","countPoints","reduce","acc","a","total","length","binaryToCode","arr","reverse","n","Math","pow","getBinaryDigits","curr","push","floor","populateMarkScheme","marks","idx","p","rawToUrl","raw","byteArray","Uint8Array","charCodeAt","populateResponseAudios","responseAudios","responseAudio","downloadAssets","SERVER_URL","question","convertToLocal","exemplarAudio","questionAudio","img","Promise","r","_","remoteUrl","fetch","fres","extractReponseAudio","arrays","res","arrayBuffer","buffer","Buffer","from","toString","all","convertToString","minutes","minuteString","seconds","secondsString"],"mappings":"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","sourcesContent":["import axios from \"axios\";\nimport { useEffect, useState } from \"react\";\nimport WaveSurfer from \"wavesurfer.js\";\nimport { produceHeat } from \"../../functions\";\nimport { MarkSchemeSection, mimeTypes, Question, startAudioRecordingId, Station } from \"./types\";\n\nexport const useLoopTime = (upperLimit: number): number => {\n    const [time, setTime] = useState(upperLimit);\n\n    useEffect(() => {\n        const interval = setInterval(() => {\n            setTime(time => {\n                if (time === 0) {\n                    clearInterval(interval);\n                    return 0;\n                } else return time - 1;\n            });\n        }, 1000);\n\n        return () => clearInterval(interval);\n    }, []);\n\n    return time;\n};\n\nexport const playStartTone = () =>\n    (document.getElementById(startAudioRecordingId) as HTMLAudioElement)?.play();\n\nconst handleAudioSession = (\n    stream: MediaStream,\n    updateFunc: (audio: string) => void,\n    startFunc: () => void\n) => {\n    // cannot make media recorder if stream invalid\n    if (!stream) return;\n\n    const recorder = new MediaRecorder(stream);\n\n    recorder.ondataavailable = function (this, e) {\n        const blob = new Blob([e.data], { type: \"audio/ogg; codecs=opus\" });\n        updateFunc(window.URL.createObjectURL(blob));\n    };\n\n    recorder.onstart = startFunc;\n\n    recorder.onstop = () => {\n        stream.getTracks().forEach(track => track.stop());\n        playStartTone();\n    };\n\n    recorder.start();\n\n    return recorder;\n};\n\nexport const useRecorder = (\n    updateFunc: (audio: string) => void,\n    startFunc: () => void\n): [() => void, () => void] => {\n    const [recorder, updateRecorder] = useState<MediaRecorder>();\n\n    // attempt to retrieve a user input stream\n    const startRecorder = async () => {\n        try {\n            const sesh = await navigator.mediaDevices.getUserMedia({ audio: true });\n            const recorder = handleAudioSession(sesh, updateFunc, startFunc);\n            updateRecorder(recorder);\n            produceHeat(11);\n        } catch (e) {\n            console.error(\"startRecorder (hooks.tsx): Failed to commence audio session\");\n        }\n    };\n\n    return [startRecorder, () => recorder?.stop()];\n};\n\nexport const generateWaveSurfer = (\n    containerId: string,\n    audioUrl: string,\n    finishCallback: () => void\n) => {\n    const ws = WaveSurfer.create(waveSurferParams(containerId));\n    if (audioUrl) ws.load(audioUrl);\n    ws.on(\"finish\", finishCallback);\n    return ws;\n};\n\nexport const waveSurferParams = (containerId: string) => ({\n    container: \"#\" + containerId,\n    waveColor: \"white\",\n    progressColor: \"#FAD000\",\n    height: 30,\n    cursorWidth: 0,\n    hideScrollbar: true,\n});\n\nexport const toggleMarkPoint = (\n    station: Station,\n    questionIdx: number,\n    pointId: number\n): Station => ({\n    ...station,\n    questions: station.questions.map((q, i) =>\n        i === questionIdx\n            ? {\n                  ...q,\n                  markScheme: q.markScheme.map(ms => ({\n                      ...ms,\n                      points: ms.points.map(pt => ({\n                          ...pt,\n                          selected: pt.pointId === pointId ? !pt.selected : pt.selected,\n                      })),\n                  })),\n              }\n            : q\n    ),\n});\n\nexport const countPoints = (markScheme: MarkSchemeSection[]): [number, number] => {\n    return markScheme.reduce(\n        (acc, a) => {\n            return [\n                acc[0] + a.points.reduce((total, pt) => total + (pt.selected ? 1 : 0), 0),\n                acc[1] + a.points.length,\n            ];\n        },\n        [0, 0]\n    );\n};\n\nexport const binaryToCode = (points: (0 | 1)[]): number => {\n    const arr = points.reverse();\n    return arr.reduce((acc, n, i) => (acc += n * Math.pow(2, i)), 0 as number);\n};\n\nexport const getBinaryDigits = (n: number): (0 | 1)[] => {\n    let curr = n;\n    let arr: (0 | 1)[] = [];\n    while (curr > 0) {\n        arr.push(curr % 2 === 0 ? 0 : 1);\n        curr = Math.floor(curr / 2);\n    }\n    return arr.reverse();\n};\n\nexport const populateMarkScheme = (station: Station, marks: (0 | 1)[]): Station => {\n    let idx = 0;\n    station.questions.forEach(q =>\n        q.markScheme.forEach(ms =>\n            ms.points.forEach(p => {\n                p.selected = marks[idx] === 1;\n                idx += 1;\n            })\n        )\n    );\n    return station;\n};\n\nexport const rawToUrl = (raw: string, type: string): string => {\n    const byteArray = new Uint8Array(raw.length);\n    for (let i = 0; i < raw.length; i++) {\n        byteArray[i] = raw.charCodeAt(i);\n    }\n    return window.URL.createObjectURL(new Blob([byteArray], { type }));\n};\n\nexport const populateResponseAudios = (station: Station, responseAudios: string[]): Station => {\n    station.questions.forEach((q, i) => {\n        q.responseAudio = rawToUrl(responseAudios[i], \"audio/mp3\");\n    });\n    return station;\n};\n\nexport const downloadAssets = async (station: Station, SERVER_URL: string): Promise<Station> => {\n    for (const question of station.questions) {\n        // get local copies of exemplar, question and img\n        question.exemplarAudio = await convertToLocal(question.exemplarAudio, SERVER_URL);\n        question.questionAudio = await convertToLocal(question.questionAudio, SERVER_URL);\n        question.img = await convertToLocal(question.img, SERVER_URL);\n    }\n    return new Promise((r, _) => r(station));\n};\n\nconst convertToLocal = async (remoteUrl: string, SERVER_URL: string): Promise<string> => {\n    const fres = await fetch(SERVER_URL + \"/media/osce/\" + remoteUrl);\n    return new Promise(async (r, _) => r(window.URL.createObjectURL(await fres.blob())));\n};\n\nexport const extractReponseAudio = async (questions: Question[]): Promise<string[]> => {\n    const arrays = questions.map(async question => {\n        if (question.responseAudio === \"\") return \"\";\n        const res = await fetch(question.responseAudio);\n        const buffer = await res.arrayBuffer(); // <== no audio upload on iphone bug\n        return Buffer.from(buffer).toString(\"binary\");\n    });\n    return Promise.all(arrays);\n};\n\nexport const convertToString = (time: number) => {\n    const minutes = Math.floor(time / 60);\n    const minuteString = minutes < 10 ? \"0\" + minutes : \"\" + minutes;\n    const seconds = time % 60;\n    const secondsString = seconds < 10 ? \"0\" + seconds : \"\" + seconds;\n    return minuteString + \":\" + secondsString;\n};\n"]},"metadata":{},"sourceType":"module"}